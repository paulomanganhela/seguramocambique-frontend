<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <title>SeguraMoçambique - Pedidos de Instalação</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
<style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f4f6f9;
      margin: 0;
      padding: 20px;
    }
    nav {
      background-color: #007b5e;
      padding: 10px;
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    nav button {
      margin-left: 10px;
      padding: 5px 10px;
      background: white;
      border: none;
      color: #03ad86;
      cursor: pointer;
      font-weight: bold;
      border-radius: 5px;
    }
    .filtros {
      margin: 20px 0;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    .filtros input, .filtros select {
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    .tabela {
      background: white;
      border-radius: 8px;
      padding: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      overflow-x: auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      padding: 8px 12px;
      border: 1px solid #ddd;
      text-align: left;
    }
    th {
      background-color: #007b5e;
      color: white;
    }
  </style>
</head>
<body>

    <nav>
        <div>SeguraMoçambique - Pedidos</div>
        <div>
          <button onclick="voltarPainel()">Painel</button>
          <button onclick="exportarExcel()">Exportar Excel</button>
          <button onclick="exportarPDF()">Exportar PDF</button>
          <button onclick="logout()">Sair</button>
        </div>
      </nav>
      
<div class="filtros">
  <input type="date" id="dataInicial" placeholder="Data Inicial">
  <input type="date" id="dataFinal" placeholder="Data Final">
  <select id="cidade">
    <option value="">Todas Cidades</option>
    <option value="Maputo">Maputo</option>
    <option value="Matola">Matola</option>
    <option value="Marracuene">Marracuene</option>
    <option value="Outros">Outros</option>
  </select>
  <select id="tipoCamera">
    <option value="">Todos Tipos</option>
    <option value="Solar4G">Solar 4G</option>
    <option value="SolarWiFi">Solar WiFi</option>
    <option value="WiFiPOE">WiFi PoE</option>
    <option value="Cabo">Com Cabo</option>
  </select>
  <button onclick="aplicarFiltros()">Aplicar Filtros</button>
  <button onclick="limparFiltros()">Limpar</button>
</div>

<div class="tabela">
  <table id="tabelaPedidos">
    <thead>
      <tr>
        <th>Data</th>
        <th>Nome</th>
        <th>Telefone</th>
        <th>Email</th>
        <th>Cidade</th>
        <th>Tipo de Câmera</th>
        <th>Compartimentos</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
  let pedidos = [];

  async function carregarPedidos() {
    try {
      const res = await fetch('https://seguramocambique-backend-1.onrender.com/api/pedidos');
      pedidos = await res.json();
      atualizarTabela(pedidos);
    } catch (err) {
      console.error('Erro ao carregar pedidos:', err);
    }
  }

  function atualizarTabela(lista) {
    const tbody = document.querySelector('#tabelaPedidos tbody');
    tbody.innerHTML = '';
    lista.forEach(p => {
      tbody.innerHTML += `
        <tr>
          <td>${new Date(p.date).toLocaleDateString('pt-MZ')}</td>
          <td>${p.nome}</td>
          <td>${p.telefone}</td>
          <td>${p.email}</td>
          <td>${p.cidade}</td>
          <td>${p.tipo_camera}</td>
          <td>${p.total_compartimentos}</td>
        </tr>`;
    });
  }

  function aplicarFiltros() {
    const dataIni = document.getElementById('dataInicial').value;
    const dataFim = document.getElementById('dataFinal').value;
    const cidade = document.getElementById('cidade').value;
    const tipoCamera = document.getElementById('tipoCamera').value;

    let filtrados = pedidos.filter(p => {
      const dataPedido = new Date(p.date);
      const passaData = (!dataIni || dataPedido >= new Date(dataIni)) && (!dataFim || dataPedido <= new Date(dataFim));
      const passaCidade = !cidade || p.cidade === cidade;
      const passaTipo = !tipoCamera || p.tipo_camera === tipoCamera;
      return passaData && passaCidade && passaTipo;
    });

    atualizarTabela(filtrados);
  }

  function limparFiltros() {
    document.getElementById('dataInicial').value = '';
    document.getElementById('dataFinal').value = '';
    document.getElementById('cidade').value = '';
    document.getElementById('tipoCamera').value = '';
    atualizarTabela(pedidos);
  }

  function exportarExcel() {
    const tabela = document.getElementById('tabelaPedidos');
    const wb = XLSX.utils.table_to_book(tabela, { sheet: "Pedidos" });
    XLSX.writeFile(wb, "pedidos_instalacao_segura.xlsx");
  }

  function voltarPainel() {
    window.location.href = "index.html";
  }

  function logout() {
    window.location.href = "index.html";
  }
  function exportarPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  doc.text("Pedidos de Instalação - SeguraMoçambique", 14, 15);

  const tabela = document.getElementById("tabelaPedidos");
  const data = [];
  
  for (let i = 1; i < tabela.rows.length; i++) {
    const row = [];
    for (let j = 0; j < tabela.rows[i].cells.length; j++) {
      row.push(tabela.rows[i].cells[j].innerText);
    }
    data.push(row);
  }

  doc.autoTable({
    head: [[
      "Data", "Nome", "Telefone", "Email", "Cidade", "Tipo de Câmera", "Compartimentos"
    ]],
    body: data,
    startY: 20,
    styles: { fontSize: 8 }
  });

  doc.save("pedidos_instalacao_segura.pdf");
}

  carregarPedidos();
</script>

</body>
</html>
